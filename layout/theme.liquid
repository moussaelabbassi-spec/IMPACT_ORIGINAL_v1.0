<!doctype html>

<html class="no-js" lang="{{ request.locale.iso_code }}" dir="{% render 'direction' %}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="theme-color" content="{{ settings.header_background }}">

    <title>{% if page_title == blank %}{{ shop.name }}{% else %}{{ page_title }}{% if current_page != 1 %} &ndash; {{ 'general.page' | t: page: current_page }}{% endif %}{% endif %}</title>

    {%- if page_description -%}
      <meta name="description" content="{{ page_description | escape }}">
    {%- endif -%}

    <link rel="canonical" href="{{ canonical_url }}">

    {%- if settings.favicon -%}
      <link rel="shortcut icon" href="{{ settings.favicon | image_url: width: 96 }}">
      <link rel="apple-touch-icon" href="{{ settings.favicon | image_url: width: 180 }}">
    {%- endif -%}

    {%- comment -%}Few prefetch to increase performance on commonly used third-parties{%- endcomment -%}
    <link rel="preconnect" href="https://cdn.shopify.com">
    <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    <link rel="dns-prefetch" href="https://productreviews.shopifycdn.com">

    {%- unless settings.heading_font.system? -%}
      <link rel="preload" href="{{ settings.heading_font | font_url }}" as="font" type="font/woff2" crossorigin>
    {%- endunless -%}

    {%- unless settings.text_font.system? -%}
      <link rel="preload" href="{{ settings.text_font | font_url }}" as="font" type="font/woff2" crossorigin>
    {%- endunless -%}

    {%- render 'social-meta-tags' -%}
    {%- render 'microdata-schema' -%}
    {%- render 'css-variables' -%}
    {%- render 'js-variables' -%}

    <script type="module" src="{{ 'vendor.min.js' | asset_url }}"></script>
    <script type="module" src="{{ 'theme.js' | asset_url }}"></script>
    <script type="module" src="{{ 'sections.js' | asset_url }}"></script>

    {{ content_for_header }}

    {{- 'theme.css' | asset_url | stylesheet_tag: preload: true -}}
  </head>

  <body class="{% if settings.show_page_transition %}page-transition{% endif %} {% if settings.zoom_image_on_hover %}zoom-image--enabled{% endif %}">
    {%- render 'shadow-dom-templates' -%}

    <a href="#main" class="skip-to-content sr-only">{{ 'general.accessibility.skip_to_content' | t }}</a>

    {%- if request.page_type != 'password' -%}
      {%- sections 'header-group' -%}
      {%- sections 'overlay-group' -%}

      {%- if settings.cart_type == 'popover' -%}
        <cart-notification-drawer open-from="bottom" class="quick-buy-drawer drawer"></cart-notification-drawer>
      {%- endif -%}
    {%- endif -%}

    {%- if request.page_type == 'customers/account' or request.page_type == 'customers/order' or request.page_type == 'customers/addresses' -%}
      {%- section 'account-banner' -%}
    {%- endif -%}

    <main role="main" id="main" class="anchor">
      {{ content_for_layout }}

      {%- comment -%}
      IMPLEMENTATION NOTE: due to the very complex logic of margin/padding collapsing, the footer group is
      added into the main element to ensure that dynamic sections added into the footer group are properly laid out.
      {%- endcomment -%}
      {%- if request.page_type != 'password' -%}
        {%- sections 'footer-group' -%}
      {%- endif -%}
    </main>
    <script>
(function () {

  // =========================
  // CONFIG (À ADAPTER)
  // =========================
  const MAIN_PRODUCT_KEYWORDS = ['lumiscop']; // ou handle exact
  const GIFT_TAG = 'Cadeau';

  async function getCart() {
    const r = await fetch('/cart.js');
    return r.json();
  }

  async function updateCart(updates) {
    await fetch('/cart/update.js', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ updates })
    });
  }

  function isMainProduct(item) {
    const t = (item.product_title || item.title || '').toLowerCase();
    return MAIN_PRODUCT_KEYWORDS.some(k => t.includes(k));
  }

  function isGift(item) {
    return (item.product_type || '').toLowerCase().includes('cadeau')
      || (item.tags || '').toLowerCase().includes('cadeau');
  }

  async function enforceRules() {
    const cart = await getCart();
    if (!cart || !cart.items) return;

    const hasMain = cart.items.some(isMainProduct);
    const gifts = cart.items.filter(isGift);

    // ❌ cadeau sans produit principal → suppression auto
    if (!hasMain && gifts.length) {
      const updates = {};
      gifts.forEach(i => updates[i.key] = 0);
      await updateCart(updates);
      location.reload();
      return;
    }

    // ❌ blocage checkout si panier = 0€
    if (cart.total_price === 0 && gifts.length) {
      const btn = document.querySelector('button[name="checkout"], .cart__checkout-button');
      if (btn) {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.title = "Ajoutez LumiScop pour valider la commande";
      }
    }
  }

  document.addEventListener('DOMContentLoaded', enforceRules);

})();
</script>
<script>
(function(){
  // Ouvre le drawer en cliquant sur l’icône panier du header (Impact l’ouvre en drawer)
  function openDrawerFallback(){
    const btn =
      document.querySelector('[data-drawer-open="cart"]') ||
      document.querySelector('a[href="/cart"][aria-label], a[href="/cart"].header__icon') ||
      document.querySelector('.header__cart, .header__icon--cart, .header__icon-cart') ||
      document.querySelector('a[href="/cart"]');
    if(btn) btn.click();
  }

  async function ajaxAddFromForm(form){
    const idInput = form.querySelector('[name="id"]');
    if(!idInput || !idInput.value) throw new Error("No variant id");
    const qtyInput = form.querySelector('[name="quantity"]');
    const quantity = qtyInput && qtyInput.value ? Number(qtyInput.value) : 1;

    const res = await fetch("/cart/add.js", {
      method: "POST",
      headers: { "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify({ id: Number(idInput.value), quantity })
    });
    if(!res.ok) throw new Error("Add failed");

    // Essaye d’ouvrir le drawer (Impact écoute parfois ces events)
    document.dispatchEvent(new CustomEvent("cart:refresh"));
    document.dispatchEvent(new CustomEvent("cart:open"));

    // Fallback sûr : clic sur l’icône panier (ouvre le drawer)
    setTimeout(openDrawerFallback, 50);
  }

  // 1) Intercepte le CLIC sur tout bouton "Ajouter au panier"
  document.addEventListener("click", function(e){
    const addBtn = e.target.closest('button[name="add"], button[type="submit"], [data-add-to-cart], .product-form__submit, .add-to-cart, #AddToCart');
    if(!addBtn) return;

    const form = addBtn.closest('form[action*="/cart/add"]') || addBtn.closest("form");
    if(!form) return;

    // On bloque la navigation / submit normal
    e.preventDefault();
    e.stopPropagation();

    ajaxAddFromForm(form).catch(err=>{
      console.error(err);
      alert("Impossible d'ajouter au panier (variant).");
    });
  }, true);

  // 2) Intercepte aussi le SUBMIT classique (au cas où)
  document.addEventListener("submit", function(e){
    const form = e.target;
    if(!form || !form.action || !form.action.includes("/cart/add")) return;

    e.preventDefault();
    e.stopPropagation();

    ajaxAddFromForm(form).catch(err=>{
      console.error(err);
      alert("Impossible d'ajouter au panier (submit).");
    });
  }, true);

  // 3) Bloque les redirections vers /cart si elles sont déclenchées juste après
  // (si une app fait window.location='/cart', le drawer s’ouvrira via fallback)
})();
</script>

  </body>
</html>