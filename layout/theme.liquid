<!doctype html>

<html class="no-js" lang="{{ request.locale.iso_code }}" dir="{% render 'direction' %}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="theme-color" content="{{ settings.header_background }}">

    <title>{% if page_title == blank %}{{ shop.name }}{% else %}{{ page_title }}{% if current_page != 1 %} &ndash; {{ 'general.page' | t: page: current_page }}{% endif %}{% endif %}</title>

    {%- if page_description -%}
      <meta name="description" content="{{ page_description | escape }}">
    {%- endif -%}

    <link rel="canonical" href="{{ canonical_url }}">

    {%- if settings.favicon -%}
      <link rel="shortcut icon" href="{{ settings.favicon | image_url: width: 96 }}">
      <link rel="apple-touch-icon" href="{{ settings.favicon | image_url: width: 180 }}">
    {%- endif -%}

    {%- comment -%}Few prefetch to increase performance on commonly used third-parties{%- endcomment -%}
    <link rel="preconnect" href="https://cdn.shopify.com">
    <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
    <link rel="dns-prefetch" href="https://productreviews.shopifycdn.com">

    {%- unless settings.heading_font.system? -%}
      <link rel="preload" href="{{ settings.heading_font | font_url }}" as="font" type="font/woff2" crossorigin>
    {%- endunless -%}

    {%- unless settings.text_font.system? -%}
      <link rel="preload" href="{{ settings.text_font | font_url }}" as="font" type="font/woff2" crossorigin>
    {%- endunless -%}

    {%- render 'social-meta-tags' -%}
    {%- render 'microdata-schema' -%}
    {%- render 'css-variables' -%}
    {%- render 'js-variables' -%}

    <script type="module" src="{{ 'vendor.min.js' | asset_url }}"></script>
    <script type="module" src="{{ 'theme.js' | asset_url }}"></script>
    <script type="module" src="{{ 'sections.js' | asset_url }}"></script>

    {{ content_for_header }}

    {{- 'theme.css' | asset_url | stylesheet_tag: preload: true -}}
  </head>

  <body class="{% if settings.show_page_transition %}page-transition{% endif %} {% if settings.zoom_image_on_hover %}zoom-image--enabled{% endif %}">
    {%- render 'shadow-dom-templates' -%}

    <a href="#main" class="skip-to-content sr-only">{{ 'general.accessibility.skip_to_content' | t }}</a>

    {%- if request.page_type != 'password' -%}
      {%- sections 'header-group' -%}
      {%- sections 'overlay-group' -%}

      {%- if settings.cart_type == 'popover' -%}
        <cart-notification-drawer open-from="bottom" class="quick-buy-drawer drawer"></cart-notification-drawer>
      {%- endif -%}
    {%- endif -%}

    {%- if request.page_type == 'customers/account' or request.page_type == 'customers/order' or request.page_type == 'customers/addresses' -%}
      {%- section 'account-banner' -%}
    {%- endif -%}

    <main role="main" id="main" class="anchor">
      {{ content_for_layout }}

      {%- comment -%}
      IMPLEMENTATION NOTE: due to the very complex logic of margin/padding collapsing, the footer group is
      added into the main element to ensure that dynamic sections added into the footer group are properly laid out.
      {%- endcomment -%}
      {%- if request.page_type != 'password' -%}
        {%- sections 'footer-group' -%}
      {%- endif -%}
    </main>
<script>
(function(){
  if (window.__NYV_ATC_V3__) return;
  window.__NYV_ATC_V3__ = true;

  // ✅ Mini indicateur (tu peux l'enlever après)
  console.log("[NYV] ATC V3 chargé ✅");

  function openDrawer(){
    const btn =
      document.querySelector('[data-drawer-open="cart"]') ||
      document.querySelector('.header__icon--cart, .header__icon-cart, .header__cart') ||
      document.querySelector('a[href="/cart"]');
    if (btn) btn.click();
  }

  function getVariantId(form){
    const idInput = form && form.querySelector('[name="id"]');
    return idInput && idInput.value ? idInput.value : null;
  }

  function getQty(form){
    const q = form && form.querySelector('[name="quantity"]');
    return q && q.value ? Number(q.value) : 1;
  }

  async function addById(id, quantity){
    const res = await fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
      body: JSON.stringify({ id: Number(id), quantity: Number(quantity || 1) })
    });

    if (!res.ok) {
      const txt = await res.text().catch(()=> "");
      throw new Error("add_failed: " + txt);
    }

    // events (Impact)
    document.dispatchEvent(new CustomEvent('cart:refresh'));
    document.dispatchEvent(new CustomEvent('cart:open'));
    setTimeout(openDrawer, 120);
  }

  async function handle(form, e){
    const id = getVariantId(form);
    if (!id) return false; // pas de variant → on laisse Shopify gérer

    e.preventDefault();
    e.stopPropagation();

    console.log("[NYV] Intercept add-to-cart, variant:", id);

    try{
      await addById(id, getQty(form));
      return true;
    }catch(err){
      console.warn("[NYV] AJAX add failed → fallback Shopify", err);

      // ✅ Fallback : on laisse Shopify faire (au moins ça marche)
      try { form.submit(); } catch(e2) {}
      return true;
    }
  }

  // 1) SUBMIT
  document.addEventListener('submit', function(e){
    const form = e.target;
    if (!form) return;
    if (!((form.action || '').includes('/cart/add'))) return;
    handle(form, e);
  }, true);

  // 2) CLIC sur bouton ATC
  document.addEventListener('click', function(e){
    const btn = e.target.closest('button[name="add"], button[type="submit"], .product-form__submit, [data-add-to-cart], #AddToCart');
    if (!btn) return;

    const form = btn.closest('form');
    if (!form) return;

    handle(form, e);
  }, true);

})();
</script>
<script>
(()=> {
  const MAIN=[56791488790911,56806659064191];
  const GIFTS=[56805951439231,56805965234559];
  let lock=false;

  async function clean(){
    if(lock) return; lock=true;
    const c=await fetch('/cart.js').then(r=>r.json());
    const hasMain=c.items.some(i=>MAIN.includes(i.variant_id));
    if(!hasMain){
      const gifts=c.items.filter(i=>GIFTS.includes(i.variant_id));
      for(const it of gifts){
        await fetch('/cart/change.js',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({id:it.key,quantity:0})
        });
      }
    }
    lock=false;
  }

  const _fetch=window.fetch;
  window.fetch=function(){
    return _fetch.apply(this,arguments).then(r=>{
      try{
        const u=((arguments[0]||'')+'');
        // ✅ seulement quand on MODIFIE/SUPPRIME le panier (pas /cart/add)
        if(u.includes('/cart/change') || u.includes('/cart/update')) setTimeout(clean,400);
      }catch(e){}
      return r;
    });
  };
})();
</script>

  </body>
</html>